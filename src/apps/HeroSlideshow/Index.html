

{#if heroes === null}
  <p>loading...</p>
{:else}
  <div class="slideshow">
    <ul>
      <HeroDetails {hero} />
    </ul>
  </div>
  <div class="timer">
    <div class="timer-bar" style="width: {timer}"></div>
  </div>
{/if}

<style>
  ul {
    width: 100%;
    list-style: none;
    margin: 0 0;
    padding: 0 0;
    overflow: hidden;
  }
  
  .hero {
    display: block;
  }
  
  .timer {
    position: fixed;
    bottom: 0vh;
    left: 0px;
    right: 0px;
    margin: 0 auto;
    height: auto;
    
  }
  
  .timer-bar {
    display: block;
    width: 100%;
    background-color: var(--primary-color);
    height: 2px;
    transition: 0.4s linear width;
    
  }

  
</style>
<script>

  import HeroDetails from "components/HeroDetails.html";

  import dotaData from "helpers/dotadata";
  dotaData.getHeroes().then(heroes => console.log(heroes));
  
  export default {
    
    oncreate() {
      let that = this;
      const { heroIndex } = this.get();
      dotaData.getHeroesAsList().then(heroes => {
        
        let hero = heroes[heroIndex];
        that.set({ heroes, heroIndex, hero, })
        that.beginAnimating();
        
      });
    },
    
    data() {
      return {
        heroes: null,
        heroIndex: 0,
        timerID: null,
        animationProgress: 0,
      }
    },
    
    computed: {
      timer: ({ animationProgress }) => Math.round(animationProgress * 100) + "%",
    },
    
    methods: {
      
      beginAnimating() {
        
        let that = this;
        let { heroIndex, heroes } = this.get();
        
        const duration = 30000;
        let start = null;
        
        let raFID = null;
        function render(dt){
          
          if (start === null) start = dt;
          const animationProgress =  (dt - start) / duration;
          
          if (animationProgress >= 1) {
           window.cancelAnimationFrame(raFID);
           nextHero();
           return;
          }
          
          that.set({ animationProgress, })
          raFID = window.requestAnimationFrame(render);
        
        }
        
        raFID = window.requestAnimationFrame(render);

        
        const nextHero = () => {
          start = null;
          const animationProgress = 0;
          heroIndex++;
          if (heroIndex >= heroes.length) heroIndex = 0;
          let hero = heroes[heroIndex];
          that.set({ heroIndex, hero, animationProgress, });
          raFID = window.requestAnimationFrame(render);
        };
      },
      
      stop() {
        let { timerID } = this.get();
        window.clearTimeout(timerID);
      }
      
    },
    
    components: { HeroDetails, },
  }
  
</script>